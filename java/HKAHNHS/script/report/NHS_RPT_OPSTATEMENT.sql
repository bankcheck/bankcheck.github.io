CREATE OR REPLACE FUNCTION "NHS_RPT_OPSTATEMENT" (
	v_SLPNO IN VARCHAR2
)
	RETURN TYPES.CURSOR_TYPE
AS
	OUTCUR TYPES.CURSOR_TYPE;
	v_Count NUMBER;
BEGIN
	SELECT COUNT(1) INTO v_Count FROM sliptx WHERE stntype = 'P' AND slpno = v_SLPNO AND stnsts = 'N';
	OPEN OUTCUR FOR
		SELECT S.SLPNO AS SLPNO,
			P.PATNO,
			NVL(P.PATLFNAME, NVL(S.SLPFNAME, P.PATFNAME))
           ||' '||NVL(P.PATLGNAME, NVL(S.SLPGNAME, P.PATGNAME)) AS PATNAME, 
			P.PATCNAME,
			D.DOCFNAME || ' ' || D.DOCGNAME AS DOCNAME,
			D.DOCCNAME,
			v_Count
		FROM  SLIP S, PATIENT P, DOCTOR D
		WHERE S.PATNO = P.PATNO(+)
		AND   S.DOCCODE = D.DOCCODE(+)
		AND   S.SLPNO = v_SLPNO;
	RETURN OUTCUR;
END NHS_RPT_OPSTATEMENT;
/
