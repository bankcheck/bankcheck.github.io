<html>
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="refresh" content="3000" />
<script type="text/javascript" src="../js/jquery-1.5.1.min.js" /></script>
<script type="text/javascript">
<!--//
	var wait = 5 * 1000;
	var tablePBO = 0;
	var tablePharmacy = 0;
	var refreshNowPBO = 0;
	var refreshNowPharmacy = 0;
	$('#lbUsers3').html("");
	$('#lbUsers5').html("");

	function timerPBO() {
		$.ajax({
			type: "POST",
			url: "patientMonitorPBO_ajax.jsp",
			data: "locid=OW&table=" + tablePBO,
			success: function(values) {
				if (values != '') {
					$('#lbUsers3').html(values);
					tablePBO++;

					// back to table after timeout
					window.setTimeout("timerPBO()", wait);
				} else {
					refreshNowPBO = 0;
					if (tablePBO != 0) {
						$('#lbUsers3').html("");
						refreshNowPBO = 1;
					}
					tablePBO = 0;

					if (refreshNowPBO == 1) {
						// refresh table 2 at once
						timerPBO();
					} else {
						// back to table after timeout
						window.setTimeout("timerPBO()", wait);
					}
				}//if
			}//success
		});//$.ajax
	}

	function timerPharmacy() {
		$.ajax({
			type: "POST",
			url: "patientMonitorPharmacy_ajax.jsp",
			data: "locid=OW&table=" + tablePharmacy,
			success: function(values) {
				if (values != '') {
					$('#lbUsers5').html(values);
					tablePharmacy++;

					// back to table after timeout
					window.setTimeout("timerPharmacy()", wait);
				} else {
					refreshNowPharmacy = 0;
					if (tablePharmacy != 0) {
						$('#lbUsers5').html("");
						refreshNowPharmacy = 1;
					}
					tablePharmacy = 0;

					if (refreshNowPharmacy == 1) {
						// refresh table 2 at once
						timerPharmacy();
					} else {
						// back to table after timeout
						window.setTimeout("timerPharmacy()", wait);
					}
				}//if
			}//success
		});//$.ajax
	}

	function startTimer() {
		timerPBO();
		timerPharmacy();
	}


	$(document).ready(function () {
		startTimer();
		defineGetElementsByClassName();
		resetblinkFont();
	});

	function blinkFont() {
		var elements = document.getElementsByClassName("blink");
		for (var i = 0; i < elements.length; i++) {
			document.getElementById(elements[i].id).style.KhtmlOpacity='0.9';
			document.getElementById(elements[i].id).style.opacity='0.9';
//			document.getElementById(elements[i].id).style.background='#6F4084';
		}
		setTimeout("resetblinkFont()", 500);
	}

	function resetblinkFont() {
		var elements = document.getElementsByClassName("blink");
		for (var i = 0; i < elements.length; i++) {
			document.getElementById(elements[i].id).style.KhtmlOpacity='0.0';
			document.getElementById(elements[i].id).style.opacity='0.0';
//			document.getElementById(elements[i].id).style.background='#FFFFFF';
		}
		setTimeout("blinkFont()", 500);
	}

	function defineGetElementsByClassName() {
		// define 'getElementsByClassName' - isn't supported in IE web browser
		if (!document.getElementsByClassName) {
			document.getElementsByClassName = function (className) {
				return this.querySelectorAll("." + className);
			}
		}
	}

	class WebSocketClient {
		constructor(protocol, hostname, port, endpoint) {

			this.webSocket = null;
			this.protocol = protocol;
			this.hostname = hostname;
			this.port     = port;
			this.endpoint = endpoint;
		}

		getServerUrl() {
			return this.protocol + "://" + this.hostname + ":" + this.port + this.endpoint;
		}

		connect() {
			try {
				this.webSocket = new WebSocket(this.getServerUrl());

				//
				// Implement WebSocket event handlers!
				//
				this.webSocket.onopen = function(event) {
					console.log('onopen::' + JSON.stringify(event, null, 4));
				}

				this.webSocket.onmessage = function(event) {
					var msg = event.data;
					if (msg.indexOf('OW') == 0) {
						recallPatient(msg.substring(3, msg.length));
					} else {
						console.log('onmessage::' + JSON.stringify(msg, null, 4));
					}
				}

				this.webSocket.onclose = function(event) {
					console.log('onclose::' + JSON.stringify(event, null, 4));
				}

				this.webSocket.onerror = function(event) {
					console.log('onerror::' + JSON.stringify(event, null, 4));
				}
			} catch (exception) {
				console.error(exception);
			}
		}

		getStatus() {
			return this.webSocket.readyState;
		}

		send(message) {
			if (this.webSocket.readyState == WebSocket.OPEN) {
				this.webSocket.send(message);
			} else {
				console.error('webSocket is not open. readyState=' + this.webSocket.readyState);
			}
		}

		disconnect() {
			if (this.webSocket.readyState == WebSocket.OPEN) {
				this.webSocket.close();
			} else {
				console.error('webSocket is not open. readyState=' + this.webSocket.readyState);
			}
		}
	}

	function recallPatient(tickets) {
		console.log('call ticket::' + tickets);
		window.location.href = 'QueueVoicePlayer:' + tickets;
		setTimeout(function() { location.reload(true); }, 1000);
	}

	var newUrl = window.location.href;
	var index = newUrl.indexOf(':80');
	if (index > 0) {
		newUrl = newUrl.substring(7, index);
	}
	var client = new WebSocketClient('ws', newUrl, 8080, '/intranet/websocket');
	client.connect();
//-->
</script>
<style type="text/css">
#table {
	position: fixed !important;
	left: 0px !important;
	right: 0px !important;
	bottom: 0px !important;

	width:100%;

	background-color:white;
	border-top:3px solid #333;

	z-index:10;
}
#wrapper2 {
	position: absolute;
	z-index: 1;
	top: 80px;
	bottom: 0;
	left: 6px;
	right: 0px;
	height:100%;
	width: 100%;
	overflow: auto;
	padding:0px;
}
#scroller2 {
	width:200px;
	height:5000px;

	padding:0;
}
#wrapper3 {
	position:absolute;
	z-index:1;
	top: 80px;
	left: 17%;
	right: 0px;
	width: 100%;
	height:100%;
	overflow:hidden;
}
#scroller3 {
	width:41%;
	height:5000px;
	padding:0;
}
#wrapper5 {
	position: absolute;
	z-index: 1;
	top: 80px;
	bottom: 0;
	left: 58%;
	right: 0px;
	height:100%;
	width: 100%;
	overflow: auto;
	padding:0px;
}
#scroller5 {
	width:41%;
	height:5000px;

	padding:0;
}
#table1 {
	position:absolute;
	width:100%;
	bottom:0; /* stick to bottom */
	background-color:Yellow;
	border-top:3px solid #333;
	height:10%;
	z-index:10;
}
	.box{border:1px solid #CCC;
}
.selected{
	background-color:yellow;
}
</style>
</head>
<body>
<!-- index page -->
<table align="center" cellspacing="0" border="0" width="100%">
	<tr>
		<td colspan="4" align="center" valign=middle bgcolor="#CC0098"><b><font face="微軟正黑體" size=7 color="#FFFFFF">取藥流程</font><font face="Arial" size=7 color="#FFFFFF">MEDICATION COLLECTION PROCESS</font></b></td>
	</tr>
</table>

<div id="wrapper2">
<div id="scroller2">
<table BORDER=0 id="lbUsers2" width="100%">
	<tr><td><img src="images/IMG_4657_ow2.jpg" alt="Process 1" style="width:300px;height:210px;"></td></tr>
	<tr><td><img src="images/IMG_4660_ow2.jpg" alt="Process 2" style="width:300px;height:210px;"></td></tr>
	<tr><td><img src="images/IMG_4661_ow2.jpg" alt="Process 3" style="width:300px;height:210px;"></td></tr>
	<tr><td><img src="images/IMG_4662_ow2.jpg" alt="Process 4" style="width:300px;height:210px;"></td></tr>
</table>
</div>
</div>

<div id="wrapper3">
<div id="scroller3">
<table BORDER=0 width="100%">
<tr>
	<td class='box'>
	<table width='100%' border='0'>
	<tr>
		<td colspan="2" width=100% align="center" valign="middle" bgcolor="#5F497A"><b><font face="微軟正黑體" size=8 color="#FFFFFF">請到繳費處交費</font><br><font face="Arial" size=8 color="#FFFFFF">Please pay at the cashier<br>&nbsp;</font></b></td>
	</tr>
	<tr>
		<table BORDER=0 id="lbUsers3" width="100%" >
		</table>
	</tr>
	</table></td>
</tr>
</table>
</div>
</div>

<div id="wrapper5">
<div id="scroller5">
<table BORDER=0 width="100%" >
<tr>
	<td class='box'>
	<table width='100%' border='0'>
	<tr>
		<td colspan="2" width=100% align="center" valign="middle" bgcolor="#76923C"><b><font face="微軟正黑體" size=8 color="#FFFFFF">請到藥劑部三或四號窗領藥</font><br><font face="Arial" size=8 color="#FFFFFF">Please collect medications at<br>Pharmacy counter 3 or 4</font></b></td>
	</tr>
	<tr>
		<table BORDER=0 id="lbUsers5" width="100%" >
		</table>

	</tr>
	</table></td>
</tr>
</table>
</div>
</div>

<div id="Footer">
<table id="table1" width="100%">
	<tr>
		<td height="20" align="left" valign=middle bgcolor="#595959"><img src="../images/tick_amber_small.gif"><b><font face="微軟正黑體" size=6 color="#FFFFFF">繳費己完成。</font><font face="Arial" size=6 color="#FFFFFF">Payment has been made.</font></b></td>
	</tr>
	<tr>
		<td height="20" align="left" valign=middle bgcolor="#595959"><b><font face="微軟正黑體" size=6 color="#FFFFFF">藥單完成後兩小時，票號將不再顯示於屏幕中，請直接到藥劑部與職員聯絡。</font><font face="Arial" size=6 color="#FFFFFF">Your ticket number will be automatically removed from the screen after it has been posted for 2 hours.</font></b></td>
	</tr>
</table>
</div>

</body>
</html>