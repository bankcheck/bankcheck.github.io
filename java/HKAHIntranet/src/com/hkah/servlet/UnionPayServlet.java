package com.hkah.servlet;

import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;

import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.hkah.util.payment.UnionPayConf;
import com.hkah.util.payment.UnionPayUtils;

/**
 * Name:Payment Request Class
 * Function:Servlet model
 * Class attribute:Public Class
 * Version:1.0
 * Date:2011-03-11
 * Writer:UPOP Team
 * Copyright:UnionPay
 * Note:The following code is just a sample for testing,acquirer and merchant can coding by themselves on the basis of the interface specificationg.
 *       The code is just for reference.
 * */
public class UnionPayServlet extends HttpServlet {
	/**
	 * 
	 */
	private static final long serialVersionUID = -6247574514957274823L;
	static int i= 0;
	public void init() {

	}

	public void service(HttpServletRequest request, HttpServletResponse response) {
		//Assemble the following request packet
		String server = request.getServerName() ;
		if ( "demo3".equals(server) || "www-server".equals(server) ) { server = server + ".AHHK.LOCAL"; }
		
		String[] valueVo = new String[]{
				UnionPayConf.version,//Protocol version  
				UnionPayConf.charset,//Character coding
	            "01",//Transaction type
	            "",//Serial number of original transaction 
	            UnionPayConf.merCode,//Merchant code
	            UnionPayConf.merName,//Abbreviation of merchant 
	            "",//Acquirer code, only need to be filled for  acquirer.
	            "",//Merchant type 
	            "http://160.100.2.99/intranet/registration/UnionPayResServlet?admissionID="+request.getParameter("admissionID"),//Commodity URL 
	            "HKAH service",//Commodity name
	            request.getParameter("vpc_Amount"),//Unit price of commodity; Unit: fen
	            "1",//Quantity of commodities
	            "0",//Discount; Unit: fen 
	            "0",//Shipping expenses; Unit: fen
	            new SimpleDateFormat("yyyyMMddHHmmss").format(new Date())+(++i),//Order number(it is required to be generated by acquirer or merchant)
	            //request.getParameter("admissionID"),//Order number(it is required to be generated by acquirer or merchant)
	            //"HKAH_ADM_ID_" + request.getParameter("admissionID"),//Order number(it is required to be generated by acquirer or merchant)
	            request.getParameter("vpc_Amount"),//Transaction amount; Unit: fen
	            //"156",//Transaction currency , 344(HKD) cannot work, will cause error
	            "344",//Transaction currency , 344(HKD) cannot work, will cause error
	            new SimpleDateFormat("yyyyMMddHHmmss").format(new Date()),//Transaction time 
	            //"127.0.0.1",//User IP 
	            "168.100.2.99",//User IP
	            "HKAH Test UPOP",//User real name 
	            "",//Default payment method
	            "",//Default bank number
	            "300000",//Transaction timeout 
	            //UnionPayConf.merFrontEndUrl,// Frontend callback merchant URL
	            //"http://160.100.2.99:8080/intranet/registration/admission_payment_return_upop.jsp?admissionID="+request.getParameter("admissionID"),
	            "http://"+ server +":"+request.getLocalPort()+"/intranet/registration/admission_payment_return_upop.jsp?admissionID="+request.getParameter("admissionID"),
				//UnionPayConf.merBackEndUrl,// Backend callback merchant URL
	            "",
	            ""//Merchant reserved field 
		};
		
		System.out.println("frontUrl 3 : " + "http://"+ server +":"+request.getLocalPort()+"/intranet/registration/admission_payment_return_upop.jsp?admissionID="+request.getParameter("admissionID"));
		
		String signType = request.getParameter("sign");
		if (!UnionPayConf.signType_SHA1withRSA.equalsIgnoreCase(signType)) {
			signType = UnionPayConf.signType;
		}
		
		/*
		 * The following code is directly return the character string which redirecting to UPOP page:
		 *   new QuickPayUtils().createPayHtml(valueVo, signType)
		 */
		String html = new UnionPayUtils().createPayHtml(valueVo, signType);//Redirecting  to UPOP page
		
		/*
		 * The following code is directly return the character string which redirecting to internet banking 
		 * payment page(The current support internet bank is: ICBC, ABC, BOC, CCB, CMB, GDB, SPDB):
		 *       new QuickPayUtils().createPayHtml(valueVo, "CCB", signType)
		 */
		//String html = new QuickPayUtils().createPayHtml(valueVo, "CCB", signType);//Redirecting to internet bank page
		response.setContentType("text/html;charset="+UnionPayConf.charset);   
		response.setCharacterEncoding(UnionPayConf.charset);
		try {
			response.getWriter().write(html);
		} catch (IOException e) {
			
		}
		response.setStatus(HttpServletResponse.SC_OK);
		System.out.println("Union Payment started");
	}
	
	
	

}
